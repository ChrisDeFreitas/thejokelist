<!doctype html>
<html>
  <head>
    <title>The Joke List</title>
    <meta charset="utf-8" />
    <meta name="description" content="Netlify version of The Joke List; retrieves data from DBHub.io/jokelist.sqlite">
    <meta name="author" content="Chris DeFreitas">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" href="noun-playful-2546421.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
  </head>
 <body>

<a href='https://github.com/ChrisDeFreitas/thejokelist' target='_new'>
  <img src='noun-playful-2546421.svg' />
</a>

<div class="controls">
  <h1>The Joke List</h1>
  <div class="buttons">

<script>
var srvtype = null
var appserver = null
var joke = null // last joke return from server

window.onload = () => {
  appserver = document.URL 
  if( appserver.indexOf( 'netlify') > 0 ){
    srvtype = 'netlify'
    appserver += '.netlify/functions/'
  }
  else{
    srvtype = 'graphql'
    appserver += 'graphql/'
  }
  console.log('appserver:', appserver)
  random()
}

function newJoke( jokePacket ){
  if( srvtype === 'graphql' ){
    let keys = Object.keys( jokePacket )
    let tmp = jokePacket[ keys[0] ]   // keys[0] === oneOf( last, next, random )
    if( tmp === null) {
      alert('A joke was not retrieved from server.\n Try a random joke by clicking "?".')
      return // error
    }
    joke = tmp
  }
  else{     // srvtype = 'netlify'
    joke = jokePacket
  }
  let title = ( joke.title === null ? 'Untitled' :joke.title.trim() )
  document.querySelector('#title').innerText = `#${joke.id}. ${title}`
  document.querySelector('#body').innerText = joke.body.trim()
}
function last( event ){
  let query = ( srvtype === 'graphql'
    ? `{ prior( id:${joke.id} ) { id, title, body }}`
    : `prior?id=${joke.id}`
  )
  load( query )
}
function next( event ){
  let query = ( srvtype === 'graphql'
    ? `{ next( id:${joke.id} ) { id, title, body }}`
    : `next?id=${joke.id}`
  )
  load( query )
}
function random( event ){
  let query = ( srvtype === 'graphql'
    ? `{ random { id, title, body }}`
    : `random`
  )
  load( query )
}
function load( query ){
  // http://localhost:4000/graphql/?query={%20random%20{%20id,%20title,%20body%20}}
  // http://127.0.0.1:8888/.netlify/functions/next?id=33
  
  let url = ( srvtype === 'graphql'
  ? appserver +'?query=' +query
  : appserver +query
  )
  // console.log('query:', url)

  fetch( url, { method: 'GET', })
  .then(response => {
    // console.log('response', response)
    return  response.json()
  })
  .then( result => {
    if( typeof result==='object' && result.title !== undefined ){ //netlify
      newJoke( result )
    } else 
    if( result.data ){    // graphql
      // console.log( 'result', result.data )
      newJoke( result.data )
    }
    else {
      if( typeof result === 'object') result = JSON.stringify( result )
      throw new Error( result )
    }
  })
  .catch( error => {
    alert('Error in Fetch request: \n' +error )
  })
}
</script>
<span id=last onclick="last()" class="material-icons" title="Last Joke">west</span>
&nbsp;
<span id=random onclick="random()" class="material-icons" title="'Random Joke">question_mark</span>
&nbsp;
<span id=next onclick="next()" class="material-icons" title="Next Joke">east</span>

  </div>
  <div class="text">

<div id='title'>Loading joke...</div>
<div id='body'></div>

  </div>
</div>

</body>
</html> 